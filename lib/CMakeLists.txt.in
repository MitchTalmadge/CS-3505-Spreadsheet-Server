include(ExternalProject)
set(LIB_INSTALL_DIR ${CMAKE_BINARY_DIR}/lib)

# ==================== Google Test Libraries ==================== #

# Attempt to locate system-installed libraries.
find_package(GTest)

if (GTEST_FOUND)
    include_directories(${GTEST_INCLUDE_DIRS})
    target_link_libraries(server_test ${GTEST_BOTH_LIBRARIES})
else ()
    set(GTEST_INSTALL_DIR ${LIB_INSTALL_DIR}/googletest)
    message("Downloading Google Test to ${GTEST_INSTALL_DIR}")

    ExternalProject_add(
            googletest

            GIT_REPOSITORY "https://github.com/google/googletest.git"
            GIT_TAG "master"

            SOURCE_DIR ${GTEST_INSTALL_DIR}/src
            BINARY_DIR ${GTEST_INSTALL_DIR}/bin

            INSTALL_COMMAND ""
    )

    add_dependencies(server_test googletest)
    include_directories(server_test ${GTEST_INSTALL_DIR}/src/googletest/include/ ${GTEST_INSTALL_DIR}/src/googlemock/include/)
    target_link_libraries(server_test gtest gtest_main gmock gmock_main)

endif ()

# ==================== Boost Libraries ==================== #

# Attempt to locate system-installed libraries.
set(Boost_USE_STATIC_LIBS ON)
set(Boost_USE_MULTITHREADED ON)
find_package(Boost 1.57.0 COMPONENTS system filesystem thread date_time)

if (Boost_FOUND)
    include_directories(server ${Boost_INCLUDE_DIRS})
    include_directories(server_test ${Boost_INCLUDE_DIRS})
    target_link_libraries(server ${Boost_LIBRARIES})
    target_link_libraries(server_test ${Boost_LIBRARIES})
endif ()

# ==================== Thread Support ==================== #

find_package(Threads)
target_link_libraries(server ${CMAKE_THREAD_LIBS_INIT})
target_link_libraries(server_test ${CMAKE_THREAD_LIBS_INIT})
